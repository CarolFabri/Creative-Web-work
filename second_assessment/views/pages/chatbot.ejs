<%- include('../partial/header') %>
<link rel="stylesheet" href="/css/chatbot.css">

<%- include('../partial/nav') %>
<%- include('../partial/borders') %>
<%- include('../partial/audio') %>
<div class="image-wrapper  chat">
<img class="start-img chat" src="/images/gypsyIllustration/gypsy-topic.png" alt="Gypsy seating to read your future">
</div>
<main class="camera-background chatGBT">

<h1 class="chatGBTtitle">Romani The Fortune Reader</h1>
<div id="chat-box" class="chat-box">
  <div class="msg bot">
    <div class="bubble">
      <strong>Romani:</strong> Ask me a question about love, career or health.
    </div>
  </div>
</div>
<div class="chat-input">
  <textarea
    id="user-input"
    rows="2"
    placeholder="Ask me about love, career, or health..."
  ></textarea>

  <div class="chat-buttons">
    <button
      type="button"
      class="button hero-button chat-send"
      onclick="sendToBot()"
    >
      Send
    </button>

    <button
      id="finish-button"
      class="button hero-button chat-finish"
      style="display:none;"
      onclick="window.location.href='/finish'"
    >
      Finish
    </button>
  </div>
</div>



<script>
  function sendToBot() {
    const message = document.getElementById('user-input').value;
    const chatBox = document.getElementById('chat-box');
    const finishBtn = document.getElementById('finish-button'); 

    if (!message) return;

    // show user message
    chatBox.innerHTML += "<p><strong>You:</strong> " + message + "</p>";

    document.getElementById('user-input').value = "";

    fetch('/chatbot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    })
      .then(async (res) => {
      const raw = await res.text();                 
      let data = {};
      try { data = JSON.parse(raw); } catch(e) {}   
// chatGBT gave me this line of code because I was having an error, I don't understand the full logic yet 
      if (!res.ok) {
        const msg = data.error || data.message || raw || "Chatbot request failed";
        throw new Error(msg);
      }
      return data;
    })
      .then(data => {
        chatBox.innerHTML += "<p><strong>Vardani:</strong> " + data.reply + "</p>";
        finishBtn.style.display = 'block';
      })
      .catch(err => {
        chatBox.innerHTML += "<p><strong>Error:</strong> something went wrong.</p>";
      });
  }
</script>

<%- include('../partial/footer') %>
